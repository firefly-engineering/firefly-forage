# Comprehensive Codebase Audit — 2026-02-12

## Methodology

Three independent agents performed a parallel audit of the entire firefly-forage codebase (129 Go files, 12 Nix files, 15 shell scripts, 33 test files, all documentation):

1. **Architecture & Maintainability Auditor** — Code quality, patterns, test coverage, documentation accuracy
2. **Security & Functional Correctness Auditor** — Vulnerability analysis, functional edge cases, test gap analysis
3. **Devil's Advocate** — Challenged assumptions, found hidden risks, identified missing capabilities

Findings were cross-referenced against the existing `REMEDIATION.md` (all items from the Feb 5 review are complete). This document captures **net-new findings only**.

---

## Findings Summary

| Severity | Count | Categories |
|----------|-------|------------|
| Critical | 5 | Privilege escalation, race conditions, file write, SSRF, env leakage |
| High | 7 | CORS, dual headers, world-readable state, cleanup failures, DNS, iptables |
| Medium | 8 | Log rotation, tmpfs verification, docs drift, code consistency, proxy identity |
| Low | 10 | Memory leaks, dead code, duplicate rules, naming, stale docs |
| Missing Features | 6 | Resource limits, audit trail, graceful shutdown, monitoring, backups, upgrade path |

---

## Phase 1: Critical Security Fixes (Immediate)

### SEC-C1: Remove Passwordless Sudo for Container Agent User
- **Files:** `lib/mkSandboxConfig.nix:124,177`, `internal/generator/templates.go:104,113`
- **Problem:** Agent user is in `wheel` group with `wheelNeedsPassword = false`, giving full root inside containers. An AI agent can trivially escalate to root and interact with host-mounted filesystems as root.
- **Fix:** Remove agent from `wheel` group. If specific privileged operations are needed, create a fine-grained sudoers whitelist for only those commands.
- **Risk if unaddressed:** Container escape to root; subversion of all in-container security controls.

### SEC-C2: Add File Locking for Concurrent Sandbox Operations
- **Files:** `internal/port/port.go:17-31`, `internal/sandbox/creator.go:56-128`
- **Problem:** No locking on sandbox creation. Two concurrent `forage-ctl up` commands can allocate the same network slot (TOCTOU race in `AllocateSlot()`), causing network collision and breaking isolation between sandboxes.
- **Fix:** Implement file-based locking (e.g., `flock` on the sandboxes directory) around slot allocation and metadata writes. Consider an atomic slot reservation mechanism.
- **Risk if unaddressed:** Two sandboxes on the same `10.100.X.0/24` subnet; network isolation completely broken.

### SEC-C3: Prevent Symlink Following in Generated File Staging
- **File:** `internal/runtime/container_info.go:53-77`
- **Problem:** `MountGeneratedFile()` calls `os.MkdirAll()` then `os.WriteFile()` without symlink checks. A race allows symlink insertion between mkdir and writeFile, redirecting writes to arbitrary host paths.
- **Fix:** Use `os.OpenFile()` with `os.O_CREATE|os.O_EXCL` and validate no symlinks exist in the path. Consider `O_NOFOLLOW` where applicable.
- **Risk if unaddressed:** Arbitrary file write on the host filesystem.

### SEC-C4: Validate Proxy Target URL Scheme and Host
- **File:** `internal/proxy/proxy.go:54-56`
- **Problem:** `url.Parse(cfg.TargetURL)` validates format but not scheme. An `http://` target transmits API keys in plaintext. No validation prevents SSRF against internal services (e.g., cloud metadata at `169.254.169.254`).
- **Fix:** Validate scheme is `https://`. Optionally whitelist allowed target hosts (e.g., `api.anthropic.com`, `api.openai.com`).
- **Risk if unaddressed:** API key disclosure via plaintext; SSRF against cloud metadata/internal services.

### SEC-C5: Filter Host Environment in syscall.Exec Calls
- **Files:** `internal/runtime/nspawn.go:256`, `internal/runtime/docker.go:317`, `internal/runtime/apple.go:313`, `internal/ssh/ssh.go:168`, `internal/system/executor.go:42`
- **Problem:** All `syscall.Exec()` calls pass `os.Environ()`, forwarding the entire host environment to child processes, including any secrets set in the host shell.
- **Fix:** Create an `allowedEnv()` helper that filters to safe variables only (PATH, HOME, USER, TERM, LANG, etc.).
- **Risk if unaddressed:** Host-side `ANTHROPIC_API_KEY`, `AWS_SECRET_ACCESS_KEY`, etc. leaked to container management processes.

---

## Phase 2: High Severity Fixes (This Sprint)

### SEC-H1: Remove Wildcard CORS from Proxy
- **File:** `internal/proxy/proxy.go:212`
- **Problem:** `Access-Control-Allow-Origin: *` on all proxy responses allows any website to make API calls through the proxy using injected API keys.
- **Fix:** Remove the CORS header entirely, or restrict to a configurable allowlist of origins.

### SEC-H2: Fix Dual Auth Header Injection
- **File:** `internal/proxy/proxy.go:134-135`
- **Problem:** Proxy sets both `X-Api-Key` and `Authorization: Bearer` with the same key. Doubles attack surface for header leakage.
- **Fix:** Use only the header required by the target API. Make header name configurable per-agent.

### SEC-H3: Restrict State Directory Permissions
- **File:** `modules/host.nix:297-299`
- **Problem:** `/var/lib/firefly-forage` is world-readable (0755). Sandbox metadata (network slots, workspace paths) is visible to all host users.
- **Fix:** Change to `0750`, restrict to owner and configured group.

### SEC-H4: Stop Exposing Secret Paths in Config
- **File:** `modules/host.nix:324`
- **Problem:** `cfg.secrets` (secret file paths) written to world-readable `/etc/firefly-forage/config.json`.
- **Fix:** Write only secret names (not paths) to config, or restrict config file permissions to `0640`.

### SEC-H5: Make Cleanup Failures Visible
- **File:** `internal/sandbox/cleanup.go:65,68-69`
- **Problem:** `IsRunning()` error silently discarded; `Destroy()` failure logged at Debug only. Orphaned containers persist with active API key access.
- **Fix:** Log at Warn/Error level. Return errors from `Cleanup()`. Add a verification step that confirms container is actually stopped.

### SEC-H6: Use nftables Consistently for Air-Gap Mode
- **File:** `internal/network/network.go:254-258`
- **Problem:** Air-gap (`none`) mode uses `iptables -A` (append), which may not take effect if existing ACCEPT rules precede it.
- **Fix:** Use nftables with `policy drop` (like restricted mode already does) for consistency and correctness.

### SEC-H7: Document DNS Resolution Timing Limitation
- **File:** `internal/network/network.go:70,277`
- **Problem:** `ResolveHosts()` resolves at config generation time, not at request time. IP changes (CDN rotation) break connectivity; DNS hijack at generation time permanently allows wrong IPs.
- **Fix:** Document as a known limitation. Consider periodic re-resolution or DNS-based nftables filtering.

---

## Phase 3: Medium Severity Fixes (Next Sprint)

### SEC-M1: Add Audit Log Rotation
- **File:** `internal/proxy/proxy.go:301,314`
- **Problem:** No size limit or rotation on audit log. Write errors silently ignored.
- **Fix:** Add log rotation (e.g., max size, file count). Report write errors at Warn level.

### SEC-M2: Verify Secrets Directory Is on tmpfs
- **File:** `modules/host.nix:300`
- **Problem:** Code assumes `/run/forage-secrets` is tmpfs but never verifies. Misconfiguration causes secrets to persist on disk.
- **Fix:** Add startup check that the secrets directory is actually on tmpfs.

### SEC-M3: Fix Misleading Secret Visibility Comment
- **File:** `lib/default.nix:22`
- **Problem:** Comment says secrets are "not visible in environment" but uses `export`, making them visible via `env`, `/proc/PID/environ`.
- **Fix:** Fix the comment to accurately reflect behavior. Consider passing secrets via file descriptor instead.

### SEC-M4: Add Proxy Sandbox Identity Verification
- **File:** `internal/proxy/proxy.go:108-112,202-208`
- **Problem:** Proxy trusts the `X-Forage-Sandbox` header set by the sandbox itself. A sandbox can claim any name and get another sandbox's API key. `identifySandbox()` is a stub returning `""`.
- **Fix:** Implement server-side verification mapping source IP/slot to sandbox name. Reject requests with mismatched identity.

### SEC-M5: Add Validation at Workspace Backend Interface
- **Files:** `internal/workspace/git.go:44-68`, `internal/workspace/jj.go:48-55`
- **Problem:** Backend functions accept `name` parameter used in branch/workspace names without interface-level validation.
- **Fix:** Add defensive validation at the Backend interface boundary (defense in depth).

### SEC-M6: Clean Up Generated File Staging Directories
- **File:** `internal/sandbox/cleanup.go:55-135`
- **Problem:** Cleanup does not remove `.generated` staging directories created by `container_info.go:60`.
- **Fix:** Add `{name}.generated` directory removal to the cleanup sequence.

### ARCH-M1: Fix Commands Bypassing paths() Helper
- **Files:** `cmd/logs.go:32`, `cmd/templates.go:25`, `cmd/network.go:50`
- **Problem:** Three commands use `config.DefaultPaths()` directly instead of `paths()` helper, bypassing app context.
- **Fix:** Change to use `paths()` from `cmd/helpers.go:13` for consistency.

### ARCH-M2: Use Typed Error in logs.go
- **File:** `cmd/logs.go:35`
- **Problem:** Uses `fmt.Errorf("sandbox not found: %s", name)` instead of `errors.SandboxNotFound(name)`.
- **Fix:** Use the typed error for consistency with all other commands.

---

## Phase 4: Low Severity Fixes (Backlog)

### SEC-L1: Fix Rate Limiter Memory Leak
- **File:** `internal/proxy/proxy.go:241-280`
- **Problem:** Old sandbox keys never removed from `requests` map.
- **Fix:** Add periodic cleanup goroutine or LRU eviction.

### SEC-L2: Remove SSH Key Path from Debug Logs
- **File:** `internal/sandbox/creator.go:516`
- **Problem:** SSH key file paths logged at Debug level.
- **Fix:** Log presence of key without revealing path.

### SEC-L3: Fix Duplicate tmpfiles Rule Generation
- **File:** `lib/mkSandboxConfig.nix:101-102`
- **Problem:** `"d /home/agent/.config 0755 agent users -"` generated twice.
- **Fix:** Deduplicate at source or add dedup in collector.

### SEC-L4: Improve Git Config Parser
- **File:** `internal/config/config.go:160-199`
- **Problem:** Simplistic line parser doesn't handle git's full INI format (quoted values, subsections).
- **Fix:** Use a proper git config parser or shell out to `git config --get`.

### ARCH-L1: Remove Dead Code in ps.go
- **File:** `cmd/ps.go:52`
- **Problem:** `_ = p` is dead code.
- **Fix:** Remove the unnecessary `paths()` call.

### ARCH-L2: Fix exec.go First Argument Quoting
- **File:** `cmd/exec.go:55-57`
- **Problem:** `shellQuote()` doesn't quote the first argument.
- **Fix:** Quote all arguments consistently.

### ARCH-L3: Hardcoded `anthropic-api-key` in Proxy
- **File:** `internal/proxy/proxy.go:179`
- **Problem:** Proxy only looks for `anthropic-api-key` files, not other providers.
- **Fix:** Make key filename configurable per-agent/template.

### ARCH-L4: Unsafe fmt.Sprintf for Config Path in reset.go
- **File:** `cmd/reset.go:48`
- **Problem:** `fmt.Sprintf("%s/%s.nix", ...)` bypasses `safePath()` protection.
- **Fix:** Use `safePath()` or `filepath.Join()` with validation.

### DOC-L1: Fix Stale PortRange Reference in doc.go
- **File:** `internal/config/doc.go`
- **Problem:** Mentions `PortRange` field that no longer exists in HostConfig.
- **Fix:** Update documentation to match current struct.

### DOC-L2: Update Skill Injection Docs
- **File:** `docs/src/usage/skill-injection.md:126-132`
- **Problem:** Describes dynamic skill generation as future work, but it's already implemented.
- **Fix:** Update to reflect current capabilities.

---

## Phase 5: Missing Features (Strategic)

These are capabilities identified as absent that significantly impact the system's fitness for running untrusted AI agents.

### FEAT-1: Container Resource Limits (High Priority)
- **Problem:** No CPU, memory, disk, or process limits. A sandbox can fork-bomb, OOM, or fill the disk.
- **Referenced in:** `DESIGN.md:52` ("Resource limits (future)")
- **Recommendation:** Implement via nspawn's `--property=` for systemd resource controls (CPUQuota, MemoryMax, TasksMax). For Docker, use `--memory`, `--cpus`, `--pids-limit`. Make configurable per-template.

### FEAT-2: Multi-Runtime Honesty (High Priority)
- **Problem:** Docker/Podman/Apple backends are incomplete — they bypass Nix config generation, use `nixos/nix sleep infinity`, and can't run full forage sandboxes. Apple Container uses Docker API syntax that may not work.
- **Recommendation:** Either invest in making these backends fully functional, or clearly mark them as experimental/alpha in docs and CLI output. Add runtime capability detection.

### FEAT-3: Graceful Shutdown Coordination (Medium Priority)
- **Problem:** `down` and `reset` destroy containers immediately with no signal to agents.
- **Recommendation:** Send SIGTERM, wait for grace period, then force kill. Optionally notify agent via a well-known file or signal.

### FEAT-4: Container Audit Trail (Medium Priority)
- **Problem:** No logging of commands executed inside sandboxes, files modified, or network connections.
- **Recommendation:** Consider systemd journal forwarding, `auditd` rules, or process accounting inside containers.

### FEAT-5: Health Monitoring Daemon (Low Priority)
- **Problem:** No automatic health checking, restart on failure, or alerting.
- **Recommendation:** Add a lightweight watchdog that periodically checks sandbox health and optionally restarts failed containers.

### FEAT-6: Sandbox State Snapshots (Low Priority)
- **Problem:** No way to snapshot before reset or rollback workspace to a previous state.
- **Recommendation:** Leverage jj/git's native capabilities for workspace snapshots. For full container state, consider filesystem snapshots (btrfs/zfs).

---

## Phase 6: Documentation Updates

### DOC-1: Update DESIGN.md Module Structure
- **File:** `DESIGN.md:430,449`
- **Problem:** References `modules/sandbox.nix`, `lib/mkAgentWrapper.nix`, `lib/types.nix` which don't exist.
- **Fix:** Update to reflect actual file layout.

### DOC-2: Fix "Stateless" Design Claim
- **File:** `DESIGN.md:129-139`
- **Problem:** Claims stateless design but system uses extensive metadata files, generated configs, skills files, permissions files, and staging directories.
- **Fix:** Rewrite to accurately describe the metadata-driven approach with gc as the consistency mechanism.

### DOC-3: Update Security Doc on Read-Only Workspace
- **File:** `docs/src/reference/security.md:182-189`
- **Problem:** Says read-only workspace mode is a future enhancement, but it's already implemented at `config.go:318` and `injection/workspace_mount.go`.
- **Fix:** Move from "future" to "current features" section.

### DOC-4: Fix Auth Obfuscation Framing in Threat Model
- **File:** `DESIGN.md:800`
- **Problem:** Lists "auth obfuscation" as a security mitigation, but the security docs correctly say it's "obfuscation, not security."
- **Fix:** Remove from security mitigations; frame as UX convenience.

---

## Implementation Priority Order

```
Week 1 (Critical):    SEC-C1, SEC-C2, SEC-C3, SEC-C4, SEC-C5
Week 2 (High):        SEC-H1, SEC-H2, SEC-H3, SEC-H4, SEC-H5, SEC-H6
Week 3 (Medium):      SEC-M1, SEC-M4, SEC-M6, ARCH-M1, ARCH-M2
Week 4 (Medium+Docs): SEC-M2, SEC-M3, SEC-M5, DOC-1 through DOC-4
Week 5+ (Strategic):  FEAT-1, FEAT-2 (these are the highest-impact missing features)
Backlog:              All Low severity items, FEAT-3 through FEAT-6
```

---

## Cross-Reference: Corroborated Findings

These findings were independently identified by multiple agents, increasing confidence:

| Finding | Agents | IDs |
|---------|--------|-----|
| Network slot race condition (no locking) | Security + Devil's Advocate | SEC-C2, DA-3.1 |
| Wildcard CORS on proxy | Security + Devil's Advocate | SEC-H1, DA-2.3 |
| Rate limiter memory leak | Security + Devil's Advocate | SEC-L1, DA-2.4 |
| Cleanup silently ignores failures | Security + Devil's Advocate | SEC-H5, DA-3.3 |
| Commands bypassing paths() helper | Architect | ARCH-M1 |
| No resource limits | Devil's Advocate | FEAT-1 |
| Multi-runtime backends incomplete | Devil's Advocate | FEAT-2 |
| DESIGN.md outdated | Architect + Devil's Advocate | DOC-1, DOC-2 |
| Duplicate tmpfiles rule | Security + Architect | SEC-L3, ARCH-2.1.1 |
| Proxy hardcoded to anthropic key | Devil's Advocate | ARCH-L3 |
| Proxy sandbox identity not verified | Devil's Advocate | SEC-M4 |

---

*Generated by 3-agent parallel audit on 2026-02-12. All findings cite specific file paths and line numbers from the current codebase.*
