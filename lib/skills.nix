# Generate skill injection content for .claude/forage-skills.md
{ lib }:
{
  template,
  sandboxName,
}:
let
  agentNames = lib.attrNames template.agents;
  agentList =
    if agentNames == [ ] then
      "No agents configured"
    else
      lib.concatMapStringsSep "\n" (name: "- `${name}` - AI coding agent") agentNames;

  networkDesc =
    {
      full = "Full internet access";
      restricted = "Restricted to allowed hosts: ${lib.concatStringsSep ", " template.allowedHosts}";
      none = "No network access (air-gapped)";
    }
    .${template.network};
in
''
  # Forage Sandbox Skills

  You are running inside a Firefly Forage sandbox named `${sandboxName}`.

  ## Environment

  - **Workspace**: `/workspace` (your working directory)
  - **Network**: ${networkDesc}
  - **Session**: tmux session `forage` (persistent across reconnections)

  ## Available Agents

  ${agentList}

  ## Sandbox Constraints

  - The root filesystem is ephemeral (tmpfs) - changes outside /workspace are lost on restart
  - `/nix/store` is read-only (shared from host)
  - `/workspace` is your persistent working directory
  - Secrets are mounted read-only at `/run/secrets/`

  ## Installing Additional Tools

  Any tool not pre-installed can be used via Nix. The sandbox has access to the
  host's Nix daemon, so you can run any package from nixpkgs:

  ```bash
  # Run a tool once
  nix run nixpkgs#ripgrep -- --help

  # Enter a shell with multiple tools
  nix shell nixpkgs#jq nixpkgs#yq

  # Build and run a flake
  nix run github:owner/repo
  ```

  This works because `/nix/store` is shared (read-only) and the Nix daemon
  handles all builds on the host. New packages appear instantly in the sandbox.

  ## Tips

  - Use `tmux` for long-running processes - your session persists across SSH disconnections
  - All project work should be done in `/workspace`
  - The sandbox can be reset with `forage-ctl reset ${sandboxName}` from the host

  ## Sub-Agent Spawning

  When spawning sub-agents (e.g., with Claude Code's Task tool), be aware:
  - Sub-agents share this same sandbox environment
  - Use tmux windows/panes for parallel agent work
  - Each sub-agent has access to the same workspace and tools

  ---
  *This file is auto-generated by Firefly Forage. Do not edit manually.*
''
